
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Heating &#8212; Home</title>
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/css/colors.css" />
    <link rel="stylesheet" type="text/css" href="../_static/css/code.css" />
    <link rel="stylesheet" type="text/css" href="../_static/css/sidebar.css" />
    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["\\(", "\\)"]], "displayMath": [["\\[", "\\]"]], "processRefs": false, "processEnvironments": false}})</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Desk" href="desk.html" />
    <link rel="prev" title="Lights" href="lights.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  <div class="document">
    
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">Lukas GitHub</a></h1>









<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script><h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Smarthome</a></li>
<li class="toctree-l1"><a class="reference internal" href="../guides/index.html">Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../templates/index.html">Templates</a></li>
</ul>


  <h3><a href="../index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Heating</a><ul>
<li><a class="reference internal" href="#radiator-thermostat">Radiator thermostat</a><ul>
<li><a class="reference internal" href="#node-red">Node-Red</a></li>
</ul>
</li>
<li><a class="reference internal" href="#temperature-sensor">Temperature sensor</a></li>
<li><a class="reference internal" href="#configuration">Configuration</a></li>
</ul>
</li>
</ul>
<h3>Projects</h3>

<ul class="want-points">
  
  <li class="toctree-l2"><a href="lights.html">Lights</a></li>
  
  <li class="toctree-l2"><a href="desk.html">Desk</a></li>
  
  <li class="toctree-l2"><a href="heating.html">Heating</a></li>
  
  <li class="toctree-l2"><a href="audiosystem.html">Multi-Room Audiosystem</a></li>
  
</ul>
        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <div class="section" id="heating">
<h1>Heating<a class="headerlink" href="#heating" title="Permalink to this headline">¶</a></h1>
<div class="section" id="radiator-thermostat">
<h2>Radiator thermostat<a class="headerlink" href="#radiator-thermostat" title="Permalink to this headline">¶</a></h2>
<p>Because I live in a flat, there is no central heating system. Therefore I control every radiator over it’s own thermostat. I went for the cheapest option: A set of <a class="reference external" href="https://www.amazon.de/-/en/Eqiva-Bluetooth®-Smart-Heizkörperthermostat-141771E0/dp/B01N39V0I4/ref=sr_1_1?dchild=1&amp;ie=UTF8&amp;keywords=blue%20heizkörperthermostat&amp;language=en_GB&amp;qid=1619821167&amp;sr=8-1">Eqiva Bluetooth Smart Radiator Thermostats</a>.</p>
<p>This devices are using bluetooth low energy therefore there is the need for at least one ESP32 to connect them to Home Assistant. For this purpose I used this really nice <a class="reference external" href="https://github.com/softypit/esp32_mqtt_eq3">EQ-3 Radiator valve control</a> application. In my case the thermostats had a very short BLE range with a maximum of about five meters. This is the main reason I choose the ESP32 solution instead of the <a class="reference external" href="https://www.home-assistant.io/integrations/eq3btsmart/">EQ3 Home Assistant integration</a>.</p>
<div class="section" id="node-red">
<h3>Node-Red<a class="headerlink" href="#node-red" title="Permalink to this headline">¶</a></h3>
<p>To make the configuration of a MQTT climate device in Home Assistant as simple as possible I added a Node-Red layer.</p>
<p>In this configuration I first created a MQTT topic for every radiator to set the temperature. But I also grouped the two thermostats in my livingroom so I can set both temperatures with one command. Next I added a topic to listen on changes of the climate mode. Depending on the mode I send a command to the radiator (mode = <em>off</em> =&gt; command = <strong>off</strong>, mode = <em>heat</em> =&gt; command = <strong>on</strong>, mode = <em>auto</em> =&gt; command = <strong>settemp 20.0</strong>).</p>
<div class="figure align-default">
<img alt="Picture of the Node-Red Subflow for Modedetection" src="../_images/thermostat_mode_detection.png" />
</div>
<p>When one of my radiators returns a statusmessage on <code class="docutils literal notranslate"><span class="pre">/&lt;mqttid&gt;radout/status</span></code> I resolve battery as well as temperature of the device and send it over a new topic. As a third value I generate the mode depending on the temperature (<span class="math notranslate nohighlight">\(temp == 4.5\)</span> =&gt; <em>off</em>, <span class="math notranslate nohighlight">\(temp == 30.0\)</span> =&gt; <em>heat</em>, <span class="math notranslate nohighlight">\(4.5 &lt; temp &lt; 30.0\)</span> =&gt; <em>auto</em>).</p>
<div class="figure align-default">
<img alt="Picture of the Node-Red Configuration" src="../_images/thermostat_config_node_red.png" />
</div>
<p>All my Node-Red Flows can be found on GitHub</p>
</div>
</div>
<div class="section" id="temperature-sensor">
<h2>Temperature sensor<a class="headerlink" href="#temperature-sensor" title="Permalink to this headline">¶</a></h2>
<p>As temperature and humidity sensors I’m using some <a class="reference external" href="https://de.aliexpress.com/item/4000373039226.html?spm=a2g0o.productlist.0.0.e1857c3fSzGao3&amp;algo_pvid=b51a18c3-9ccf-4b9a-b9d0-d6b49b2ddc36&amp;algo_expid=b51a18c3-9ccf-4b9a-b9d0-d6b49b2ddc36-0&amp;btsid=0bb0623d16200470086374093ef357&amp;ws_ab_test=searchweb0_0,searchweb201602_,searchweb201603_">Xiaomi Mija Bluetooth Thermometer</a>. Just like the thermostats a ESP32 is needed but in this case ESPHome provides a <a class="reference external" href="https://esphome.io/components/sensor/xiaomi_ble.html?highlight=xiaomi#lywsd03mmc">viable solution</a>. To use the sensors with ESPHome you need to flash a custom firmware like explained in this repository: <a class="reference external" href="https://github.com/atc1441/ATC_MiThermometer">https://github.com/atc1441/ATC_MiThermometer</a>. Now you can flash your ESP32 with your ESPHome configuration and the sensors are ready. To later use them as temperature for the MQTT climate entity I also added MQTT to the ESPHome configuration.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">mqtt</span><span class="p">:</span>
    <span class="nt">broker</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">&lt;mqtt broker ip&gt;</span>
    <span class="nt">username</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">&lt;username&gt;</span>
    <span class="nt">password</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">&lt;password&gt;</span>
    <span class="nt">discovery</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">False</span>
</pre></div>
</div>
<p>To send the sensordata over a MQTT topic you have to add the following code to the sensor.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">on_value</span><span class="p">:</span>
    <span class="nt">then</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="nt">mqtt.publish_json</span><span class="p">:</span>
          <span class="nt">topic</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">&lt;topic&gt;</span>
          <span class="nt">payload</span><span class="p">:</span> <span class="p p-Indicator">|-</span>
            <span class="no">root[&quot;payload&quot;] = id(&lt;sensor Id&gt;).state;</span>
            <span class="no">root[&quot;device&quot;] = &quot;&lt;device name&gt;&quot;;</span>
</pre></div>
</div>
<p>Compared to the EQ3 thermostats the ble range of the mija ble thermometer is a lot better. In my case I could connect all devices with one ESP32.</p>
</div>
<div class="section" id="configuration">
<h2>Configuration<a class="headerlink" href="#configuration" title="Permalink to this headline">¶</a></h2>
<p>For the configuration of my custom climate entity I used the MQTT climate platform with the following configuration:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="p p-Indicator">-</span> <span class="nt">platform</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">mqtt</span>
  <span class="nt">name</span><span class="p">:</span> <span class="s">&quot;eq3</span><span class="nv"> </span><span class="s">Schlafzimmer</span><span class="nv"> </span><span class="s">Lukas&quot;</span>
  <span class="nt">unique_id</span><span class="p">:</span> <span class="s">&quot;eq3_bedroom_lukas&quot;</span>
  <span class="nt">modes</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="s">&quot;heat&quot;</span>
    <span class="p p-Indicator">-</span> <span class="s">&quot;off&quot;</span>
    <span class="p p-Indicator">-</span> <span class="s">&quot;auto&quot;</span>
  <span class="nt">mode_command_topic</span><span class="p">:</span> <span class="s">&quot;heating/bedroom_lukas/mode&quot;</span>
  <span class="nt">mode_state_topic</span><span class="p">:</span> <span class="s">&quot;heating/bedroom_lukas/status&quot;</span>
  <span class="nt">mode_state_template</span><span class="p">:</span> <span class="s">&quot;{{value_json.mode}}&quot;</span>
  <span class="nt">max_temp</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">30.0</span>
  <span class="nt">min_temp</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">5.0</span>
  <span class="nt">initial</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">20</span>
  <span class="nt">temperature_command_topic</span><span class="p">:</span> <span class="s">&quot;heating/bedroom_lukas/temp&quot;</span>
  <span class="nt">current_temperature_topic</span><span class="p">:</span> <span class="s">&quot;thermometer/temperature/bedroom-lukas&quot;</span>
  <span class="nt">temperature_unit</span><span class="p">:</span> <span class="s">&quot;C&quot;</span>
  <span class="nt">temp_step</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">0.5</span>
</pre></div>
</div>
<p>Now when I set the temperature of my radiator in Home Assistant the target temperature of the EQ3 thermostat changes (<code class="docutils literal notranslate"><span class="pre">temperature_command_topic:</span> <span class="pre">&quot;heating/bedroom_lukas/temp&quot;</span></code>).  So the whole controlling of the radiator still happens on the EQ3 with it’s build in temperature sensor but the entity in Home Assistant displays the temperature measured by the Xiaomi sensors (<code class="docutils literal notranslate"><span class="pre">&quot;current_temperature_topic:</span> <span class="pre">&quot;thermometer/temperature/bedroom-lukas&quot;</span></code>).</p>
<div class="figure align-default" style="width: 500px">
<img alt="Thermostat card in Home Assistant" src="../_images/hassio_thermostat_card.png" />
</div>
</div>
</div>


          </div>
          
        </div>
      </div>
    <div class="clearer"></div>
  </div>
    <div class="footer">
      &copy;2021, Lukas Schüttler.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 3.5.4</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../_sources/smarthome/heating.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>